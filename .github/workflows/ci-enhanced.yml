# Enhanced CI Pipeline for MCP Gateway
# Comprehensive testing, coverage reporting, and performance benchmarking

name: Enhanced CI Pipeline

on:
  push:
    branches: [main, master, dev, release/*, feature/*, feat/*]
  pull_request:
    branches: [main, master, dev, release/*, feature/*, feat/*]

# Environment variables
env:
  NODE_VERSION: "22"
  PYTHON_VERSION: "3.12"
  COVERAGE_THRESHOLD: "80"
  CACHE_VERSION: "v3"
  PERFORMANCE_TEST_DURATION: "300"

jobs:
  # Enhanced Python Testing with Comprehensive Coverage
  test-python-enhanced:
    name: Enhanced Python Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: "pyproject.toml"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Cache test dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Run linting and formatting checks
        run: |
          ruff check tool_router/ dribbble_mcp/ validate_config.py --output-format=github
          black --check tool_router/ dribbble_mcp/ validate_config.py
          mypy tool_router/ --ignore-missing-imports || true

      - name: Run unit tests with coverage
        run: |
          pytest tool_router/tests/ \
            --cov=tool_router \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }} \
            -v \
            --tb=short \
            --maxfail=5 \
            --dist=loadscope \
            -n auto

      - name: Run integration tests
        continue-on-error: true
        run: |
          pytest tool_router/tests/integration/ \
            --cov=tool_router \
            --cov-append \
            --cov-report=xml \
            -v \
            --tb=short \
            --maxfail=3

      - name: Run performance benchmarks
        continue-on-error: true
        run: |
          pytest tool_router/tests/performance/ \
            --benchmark-only \
            --benchmark-json=benchmark-results-${{ matrix.python-version }}.json \
            --benchmark-sort=mean \
            -v

      - name: Generate coverage report
        continue-on-error: true
        run: |
          coverage report --show-missing
          coverage html -d coverage-html-${{ matrix.python-version }}

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: |
            coverage.xml
            coverage-html-${{ matrix.python-version }}/
          retention-days: 30

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ matrix.python-version }}
          path: benchmark-results-${{ matrix.python-version }}.json
          retention-days: 30
          if-no-files-found: ignore

  # Security Scanning with Enhanced Coverage
  security-enhanced:
    name: Enhanced Security Scans
    runs-on: ubuntu-latest
    timeout-minutes: 30
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run pip audit
        run: |
          pip install pip-audit
          pip-audit || true

      - name: Run Bandit Security Analysis
        run: |
          pip install bandit[toml]
          bandit -r tool_router/ -f json -o bandit-report.json || true
          bandit -r tool_router/ -f txt || true

      - name: Run Safety Check
        run: |
          pip install safety
          safety check --json --output safety-report.json || true
          safety check || true

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 30
          if-no-files-found: ignore

  # Docker Build and Security Scanning
  docker-enhanced:
    name: Enhanced Docker Build & Security
    runs-on: ubuntu-latest
    timeout-minutes: 45
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create required env files for docker compose
        run: |
          touch .env.shared .env.development .env.production .env

      - name: Build Docker images
        run: |
          docker compose -f docker-compose.yml build --no-cache 2>&1 || echo "Docker build completed with warnings"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Test Docker containers
        continue-on-error: true
        run: |
          docker compose -f docker-compose.yml up -d 2>&1 || exit 0
          sleep 30
          curl -f http://localhost:4444/health || true
          curl -f http://localhost:9000/health || true
          docker compose -f docker-compose.yml down || true

  # Performance Testing and Benchmarking
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install performance testing tools
        run: |
          pip install -e .
          pip install locust pytest-benchmark

      - name: Run load tests
        continue-on-error: true
        run: |
          touch .env.shared .env.development
          docker compose -f docker-compose.yml up -d 2>&1 || exit 0
          sleep 60
          locust -f tests/performance/locustfile.py \
            --headless \
            --users 50 \
            --spawn-rate 5 \
            --run-time ${{ env.PERFORMANCE_TEST_DURATION }} \
            --host http://localhost:4444 \
            --html performance-report.html || true
          docker compose -f docker-compose.yml down || true

      - name: Run API performance benchmarks
        continue-on-error: true
        run: |
          pytest tests/performance/api_benchmarks.py \
            --benchmark-only \
            --benchmark-json=api-benchmarks.json \
            --benchmark-sort=mean || true

      - name: Upload performance reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            performance-report.html
            api-benchmarks.json
          retention-days: 30
          if-no-files-found: ignore

  # Quality Gates and Reporting
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test-python-enhanced, security-enhanced, docker-enhanced]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate quality report summary
        run: |
          echo "=== Quality Report Summary ==="
          echo "Test Python: ${{ needs.test-python-enhanced.result }}"
          echo "Security Scans: ${{ needs.security-enhanced.result }}"
          echo "Docker Build: ${{ needs.docker-enhanced.result }}"

      - name: Comment PR with quality metrics
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const testResult = '${{ needs.test-python-enhanced.result }}';
            const securityResult = '${{ needs.security-enhanced.result }}';
            const dockerResult = '${{ needs.docker-enhanced.result }}';

            const comment = [
              '## Quality Metrics Report',
              '',
              '| Check | Status |',
              '|-------|--------|',
              `| Python Tests | ${testResult} |`,
              `| Security Scans | ${securityResult} |`,
              `| Docker Build | ${dockerResult} |`,
              '',
              '---',
              '*Generated by Enhanced CI Pipeline*'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Documentation Generation
  docs-generation:
    name: Documentation Generation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test-python-enhanced]
    if: always() && needs.test-python-enhanced.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install documentation tools
        run: |
          pip install -e .
          pip install sphinx sphinx-rtd-theme

      - name: Generate API documentation
        run: |
          sphinx-apidoc -o docs/api tool_router/ --force --module-first || true
          cd docs && make html || true

      - name: Upload documentation
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: docs/_build/html/
          retention-days: 30
          if-no-files-found: ignore
